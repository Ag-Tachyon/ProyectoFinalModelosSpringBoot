<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Usuario</title>
    <style>
        .ref-card {
            border: 1px solid #ccc;
            padding: 15px;
            margin-bottom: 25px;
            border-radius: 8px;
            background: #fafafa;
        }
        .mascota-card {
            width: 220px;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 10px;
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .mascota-img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 8px;
        }
    </style>
</head>

<body>

<div>
    <input id="nombreUsuario" type="text" placeholder="Tu nombre">
    <button id="btnSub">Recibir notificaciones</button>
    <button id="btnUnsub">Dejar de recibir</button>

    <p><strong>Observadores actuales:</strong> <span id="cantObs">0</span></p>
</div>

<hr>

<h2>Refugios y Mascotas Disponibles</h2>
<div id="listaRefugios" style="margin-top:20px;"></div>

<hr>

<h3>Tus Notificaciones:</h3>
<div id="notificaciones"></div>


<div style="margin-top:30px;">
    <h3>Proceso de Adopci贸n</h3>
    <input id="usuarioIdInput" type="text" placeholder="Tu nombre de usuario para adoptar">

    <!-- ID de la mascota seleccionada autom谩ticamente por el bot贸n Adoptar -->
    <input id="mascotaIdHidden" type="hidden">

    <button id="btnAdoptar">Adoptar esta Mascota</button>

    <p id="resultadoAdopcion" style="margin-top: 15px; font-weight: bold;"></p>
</div>


<script>
    /* ===============================================
       ZONA DE SUSCRIPCIN / OBSERVER (NO SE EDITA)
    =============================================== */

    const nombreInput = document.getElementById("nombreUsuario");
    const cantObs = document.getElementById("cantObs");
    const notificacionesDiv = document.getElementById("notificaciones");
    const USUARIO_KEY = "observer_nombre";

    async function actualizarCantidad() {
        const resp = await fetch(`/notificaciones/cantidad`);
        const data = await resp.json();
        cantObs.textContent = data.cantidad;
    }

    actualizarCantidad();

    const nombreGuardado = localStorage.getItem(USUARIO_KEY);
    if (nombreGuardado) {
        nombreInput.value = nombreGuardado;
    }

    document.getElementById("btnSub").onclick = async () => {
        const nombre = nombreInput.value;
        if (!nombre) return alert("Por favor, ingresa tu nombre.");

        const resp = await fetch(`/notificaciones/suscribirse?nombre=${nombre}`, {
            method: "POST"
        });

        const data = await resp.json();
        cantObs.textContent = data.cantidad;
        localStorage.setItem(USUARIO_KEY, nombre);
        alert(`Suscripci贸n exitosa para ${nombre}`);
    };

    document.getElementById("btnUnsub").onclick = async () => {
        const nombre = nombreInput.value;
        if (!nombre) return alert("Por favor, ingresa tu nombre.");

        const resp = await fetch(`/notificaciones/desuscribirse?nombre=${nombre}`, {
            method: "POST"
        });

        const data = await resp.json();
        cantObs.textContent = data.cantidad;
        localStorage.removeItem(USUARIO_KEY);
        alert(`Desuscripci贸n exitosa para ${nombre}`);
    };


    /* =================================================
       LISTAR REFUGIOS Y SUS MASCOTAS (NUEVA SECCIN)
    ================================================= */

    async function cargarRefugiosConMascotas() {
        const contenedor = document.getElementById("listaRefugios");

        try {
            const resp = await fetch("/refugios");
            const refugios = await resp.json();

            if (!refugios || refugios.length === 0) {
                contenedor.innerHTML = "<p>No hay refugios registrados.</p>";
                return;
            }

            contenedor.innerHTML = "";

            refugios.forEach(ref => {

                const card = document.createElement("div");
                card.classList.add("ref-card");

                card.innerHTML = `
                    <h3> Refugio: ${ref.nombre}</h3>
                    <p><strong>Direcci贸n:</strong> ${ref.direccion}</p>
                    <p><strong>Capacidad:</strong> ${ref.capacidad}</p>
                    <p><strong>Mascotas:</strong> ${ref.mascotas ? ref.mascotas.length : 0}</p>
                    <h4 style="margin-top:15px;"> Mascotas:</h4>
                `;

                const listaMascotas = document.createElement("div");
                listaMascotas.style.display = "flex";
                listaMascotas.style.flexWrap = "wrap";
                listaMascotas.style.gap = "15px";

                if (ref.mascotas && ref.mascotas.length > 0) {
                    ref.mascotas.forEach(m => {
                        const mCard = document.createElement("div");
                        mCard.classList.add("mascota-card");

                        mCard.innerHTML = `
                            <img class="mascota-img"
                                 src="${m.imagenUrl || 'https://via.placeholder.com/200'}">

                            <h4 style="margin:10px 0 5px;">${m.nombre}</h4>
                            <p><strong>Raza:</strong> ${m.raza}</p>
                            <p><strong>Edad:</strong> ${m.edad}</p>
                            <p><strong>Sexo:</strong> ${m.sexo}</p>
                            <p><strong>Tama帽o:</strong> ${m.size}</p>

                            <button onclick="seleccionarMascota('${m.id}')"
                                style="margin-top:10px; width:100%; padding:6px; border:none;
                                background:#4CAF50; color:white; border-radius:5px; cursor:pointer;">
                                Adoptar
                            </button>
                        `;

                        listaMascotas.appendChild(mCard);
                    });
                } else {
                    listaMascotas.innerHTML = "<p>No hay mascotas en este refugio.</p>";
                }

                card.appendChild(listaMascotas);
                contenedor.appendChild(card);
            });

        } catch (error) {
            contenedor.innerHTML = "<p>Error cargando refugios.</p>";
            console.error(error);
        }
    }

    /* Cuando el usuario escoge una mascota */
    function seleccionarMascota(id) {
        document.getElementById("mascotaIdHidden").value = id;
        alert("Mascota seleccionada.");
    }

    /* Cargar al iniciar */
    document.addEventListener("DOMContentLoaded", () => {
        cargarRefugiosConMascotas();
    });


    /* ==================================================
       PROCESO DE ADOPCIN (YA LO TENAS)
    ================================================== */

    document.getElementById("btnAdoptar").onclick = async () => {
        const usuarioId = document.getElementById("usuarioIdInput").value;
        const mascotaId = document.getElementById("mascotaIdHidden").value;
        const resultado = document.getElementById("resultadoAdopcion");

        if (!usuarioId || !mascotaId) {
            resultado.style.color = "red";
            resultado.textContent = "Debes ingresar usuario y seleccionar mascota.";
            return;
        }

        const url = `/adopciones/adoptar?mascotaId=${encodeURIComponent(mascotaId)}&usuarioId=${encodeURIComponent(usuarioId)}`;

        try {
            const resp = await fetch(url, { method: "POST" });

            if (resp.ok) {
                const msg = await resp.text();
                resultado.style.color = "green";
                resultado.textContent = msg;
                document.getElementById("btnAdoptar").disabled = true;
            } else {
                const err = await resp.text();
                resultado.style.color = "red";
                resultado.textContent = err;
            }

        } catch (e) {
            resultado.style.color = "red";
            resultado.textContent = "Error de conexi贸n.";
        }
    };

</script>

</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Refugios</title>

    <link rel="stylesheet" href="./styles/reset.css">
    <link rel="stylesheet" href="./styles/bases.css">
    <link rel="stylesheet" href="./styles/admin.css">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@200;400;700&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
</head>

<body style="height: 100vh; display: flex; flex-direction: column;">

<!-- HEADER -->
<header class="header flex">
    <div class="header__icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-ease-in-out-control-points"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M17 20a2 2 0 1 0 4 0a2 2 0 0 0 -4 0z" /><path d="M17 20h-2" /><path d="M7 4a2 2 0 1 1 -4 0a2 2 0 0 1 4 0z" /><path d="M7 4h2" /><path d="M14 4h-2" /><path d="M12 20h-2" /><path d="M3 20c8 0 10 -16 18 -16" /></svg>
    </div>

    <div class="flex header__info-container">
        <div class="flex header__input-container">
            <input type="search" class="header__search" placeholder="Buscar" autocomplete="off">

            <button class="flex header__btn header__btn--filtrar">Filtrar</button>

            <!-- BOT√ìN FORM REFUGIO -->
            <button id="btnMostrarForm" class="flex header__btn header__btn--plus">
                Registrar Refugio
            </button>

            <!-- BOT√ìN FORM MASCOTA -->
            <button id="btnRegistrarMascota" class="flex header__btn header__btn--plus" style="background-color:#76a5ff;">
                Registrar Mascota
            </button>
        </div>
    </div>
</header>

<!-- MAIN -->
<main class="flex main">
    <nav class="aside">
        <ul class="aside__ul">
            <li class="aside__list-item">Inicio</li>
            <li class="aside__list-item">Bandeja</li>
            <li class="aside__list-item">Equipos</li>
            <li class="aside__list-item">Paneles</li>
            <li class="aside__list-item">Formularios</li>
        </ul>
    </nav>

    <!-- LISTA REFUGIOS -->
    <section class="flex info-refugios-container">
        <div class="refugios-info refugios-list">
            <header class="flex refugios-list__header">
                <h2 class="refugios-list__title">Refugios</h2>
            </header>

            <div class="refugios-list__list" id="contenedorRefugios">
                <!-- Se llenan din√°micamente -->
            </div>
        </div>
    </section>
</main>

<!-- FORM REFUGIO -->
<form id="formRefugio" style="display: none;" class="form-refugio">
    <h3>Registrar Refugio</h3>

    <input type="text" id="nombre" placeholder="Nombre" required>
    <input type="text" id="direccion" placeholder="Direcci√≥n" required>
    <input type="number" id="capacidad" placeholder="Capacidad" required>

    <select id="tipo" required>
        <option value="gatos">Refugio de Gatos üê±</option>
        <option value="perros">Refugio de Perros üê∂</option>
    </select>

    <button type="submit">Guardar</button>
</form>

<!-- FORM MASCOTA -->
<form id="formMascota" style="display: none;" class="form-refugio">
    <h3>Registrar Mascota</h3>

    <input type="text" id="m_nombre" placeholder="Nombre" required>
    <input type="text" id="m_raza" placeholder="Raza" required>

    <select id="m_size" required>
        <option value="peque√±o">Peque√±o</option>
        <option value="mediano">Mediano</option>
        <option value="grande">Grande</option>
    </select>

    <input type="number" id="m_edad" placeholder="Edad" required>

    <select id="m_sexo" required>
        <option value="macho">Macho</option>
        <option value="hembra">Hembra</option>
    </select>

    <!-- ‚≠ê CAMPO NUEVO: URL DE IMAGEN -->
    <input type="text" id="m_imagen" placeholder="URL de imagen " required>

    <select id="m_refugio" required></select>

    <button type="submit">Guardar Mascota</button>
</form>


<!-- SCRIPTS -->
<script>
    /* Mostrar/Ocultar formularios */
    const formRef = document.getElementById("formRefugio");
    const btnMostrar = document.getElementById("btnMostrarForm");

    btnMostrar.onclick = () => {
        formRef.style.display = formRef.style.display === "none" ? "block" : "none";
    };

    const btnMascota = document.getElementById("btnRegistrarMascota");
    const formMascota = document.getElementById("formMascota");

    btnMascota.onclick = () => {
        formMascota.style.display = formMascota.style.display === "none" ? "block" : "none";
        cargarRefugiosEnSelectMascota();
    };


    /* Cargar refugios en el select */
    async function cargarRefugiosEnSelectMascota() {
        const resp = await fetch("/refugios");
        const lista = await resp.json();

        const select = document.getElementById("m_refugio");
        select.innerHTML = "";

        lista.forEach(r => {
            select.innerHTML += `<option value="${r.nombre}">${r.nombre}</option>`;
        });
    }


    /* Registrar Mascota */
    document.getElementById("formMascota").addEventListener("submit", async (e) => {
        e.preventDefault();

        const mascota = {
            nombre: document.getElementById("m_nombre").value,
            raza: document.getElementById("m_raza").value,
            size: document.getElementById("m_size").value,
            edad: parseInt(document.getElementById("m_edad").value),
            sexo: document.getElementById("m_sexo").value,
            imagenUrl: document.getElementById("m_imagen").value  // ‚≠ê Nuevo!
        };

        const refugio = document.getElementById("m_refugio").value;

        const resp = await fetch(`/mascotas/registrar?refugio=${refugio}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(mascota)
        });

        if (resp.ok) {
            alert("Mascota registrada correctamente");
            formMascota.reset();
            formMascota.style.display = "none";
            cargarRefugios();
        } else {
            alert("Error al registrar la mascota");
        }
    });


    /* Cargar y mostrar refugios */
    async function cargarRefugios() {
        const resp = await fetch("/refugios");
        const refugios = await resp.json();
        mostrarRefugios(refugios);
    }

    function mostrarRefugios(refugios) {
        const cont = document.getElementById("contenedorRefugios");
        cont.innerHTML = "";

        refugios.forEach(refugio => {
            const card = document.createElement("div");
            card.classList.add("refugio", "card");

            card.innerHTML = `
                <h3>${refugio.nombre}</h3>
                <p><strong>Tipo:</strong> ${refugio.tipo}</p>
                <p><strong>Direcci√≥n:</strong> ${refugio.direccion}</p>
                <p><strong>Capacidad:</strong> ${refugio.capacidad}</p>
                <p><strong>Mascotas:</strong> ${refugio.mascotas ? refugio.mascotas.length : 0}</p>
            `;

            cont.appendChild(card);
        });
    }

    document.addEventListener("DOMContentLoaded", cargarRefugios);
</script>

</body>
</html>
